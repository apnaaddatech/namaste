<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>NAMASTE - Powered by Apna Adda</title>
    
    <!-- Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #25D366;
            --primary-dark: #128C7E;
            --bg-color: #121212;
            --surface-color: #1E1E1E;
            --message-received: #2A2A2A;
            --message-sent: #005c4b;
            --text-color: #FFFFFF;
            --text-secondary: #B0B3B8;
            --danger: #FF3B30;
            --accent-gradient: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: #000;
            color: var(--text-color);
            height: 100vh;
            height: 100dvh; 
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden; 
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-arrival { animation: fadeIn 0.4s ease-out forwards; }

        /* --- Main Container --- */
        #app-container {
            background-color: var(--bg-color);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column; 
            transition: all 0.5s ease-in-out;
        }

        #app-container.layout-web { width: 100%; height: 100%; max-width: 100%; border-radius: 0; overflow-y: auto; display: block; }
        
        #app-container.layout-mobile {
            width: 100%; 
            max-width: 450px; 
            height: 100%; 
            max-height: 100dvh;
            border-radius: 0; 
            box-shadow: none;
            border: none;
        }

        @media (min-width: 501px) {
            #app-container.layout-mobile {
                height: 95vh;
                border-radius: 20px;
                border: 1px solid #333;
                box-shadow: 0 0 50px rgba(37, 211, 102, 0.15);
            }
        }

        /* --- Components --- */
        button { cursor: pointer; border: none; outline: none; transition: all 0.3s ease; }

        .btn-primary {
            background: var(--accent-gradient); color: white;
            padding: 12px 24px; border-radius: 30px; font-weight: 600; width: 100%; font-size: 16px;
            box-shadow: 0 4px 15px rgba(37, 211, 102, 0.3);
        }
        .btn-primary:active { transform: scale(0.98); }
        .btn-secondary {
            background: transparent; border: 2px solid var(--primary); color: var(--primary);
            padding: 12px 24px; border-radius: 30px; font-weight: 600; width: 100%; margin-top: 10px;
        }
        .btn-cancel-edit { background: #333; color: white; margin-top: 10px; width: 100%; padding: 12px; border-radius: 30px; }

        input[type="text"], input[type="email"], input[type="password"] {
            width: 100%; padding: 15px; background: var(--surface-color);
            border: 1px solid #333; border-radius: 12px; color: white; margin-bottom: 15px; font-size: 16px; 
        }
        input:focus { border-color: var(--primary); }

        /* --- Screens --- */
        .screen { display: none; flex-direction: column; height: 100%; width: 100%; background: var(--bg-color); }
        .screen.active { display: flex; }
        #app-container.layout-web .screen.active { display: block; height: auto; min-height: 100%; }

        /* --- Home Screen --- */
        #home-screen { padding: 40px; max-width: 1200px; margin: 0 auto; overflow-y: auto; }
        .hero-section { text-align: center; margin-top: 20px; margin-bottom: 50px; }
        .app-title { font-size: 48px; font-weight: 700; color: var(--primary); letter-spacing: 2px; }
        .tagline { font-size: 16px; color: var(--text-secondary); margin-top: 5px; text-transform: uppercase; letter-spacing: 3px; }
        
        .highlights-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 25px; margin-bottom: 50px; }
        .highlight-card { background: var(--surface-color); padding: 30px; border-radius: 15px; border-left: 4px solid var(--primary); }
        .highlight-title { font-weight: 600; color: var(--silver); margin-bottom: 12px; font-size: 18px; display: flex; align-items: center; gap: 10px; }
        .highlight-desc { font-size: 14px; color: var(--text-secondary); line-height: 1.6; }
        .about-section { background: #1a1a1a; padding: 40px; border-radius: 15px; margin: 20px auto; font-size: 14px; color: var(--text-secondary); line-height: 1.8; max-width: 800px; border: 1px solid #333; }
        
        .home-footer { margin-top: 50px; padding: 30px 0; text-align: center; display: flex; flex-direction: column; align-items: center; gap: 20px; border-top: 1px solid #333; }
        .social-row { display: flex; gap: 15px; flex-wrap: wrap; justify-content: center; }
        .social-link { color: var(--primary); text-decoration: none; font-size: 14px; display: inline-flex; align-items: center; gap: 8px; background: #222; padding: 10px 15px; border-radius: 20px; border: 1px solid #333; transition: all 0.3s; }
        .footer-credits { margin-top: 20px; font-size: 11px; color: #555; letter-spacing: 1px; line-height: 1.6; text-transform: uppercase; }

        /* --- Auth & Profile --- */
        .auth-container { padding: 30px; display: flex; flex-direction: column; justify-content: center; height: 100%; overflow-y: auto; }
        .dp-preview-wrapper { width: 120px; height: 120px; margin: 0 auto 20px auto; position: relative; flex-shrink: 0; }
        .dp-preview-img { width: 100%; height: 100%; border-radius: 50%; border: 3px solid var(--primary); object-fit: cover; background: #222; }
        .emoji-selector { display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px; margin-bottom: 20px; padding: 10px; background: #222; border-radius: 15px; max-height: 150px; overflow-y: auto; }
        .emoji-btn { font-size: 24px; background: transparent; cursor: pointer; padding: 5px; border-radius: 5px; text-align: center; }
        .emoji-btn.selected { background: var(--primary-dark); }

        /* --- App Header --- */
        .app-header { 
            padding: 15px 20px; 
            padding-top: max(15px, var(--safe-top)); 
            background: var(--surface-color); 
            display: flex; justify-content: space-between; align-items: center; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.3); z-index: 20; 
            flex-shrink: 0; 
        }
        .header-title { font-size: 18px; font-weight: 700; color: white; }
        .more-options { padding: 10px; cursor: pointer; } 
        .dropdown-menu { position: absolute; right: 10px; top: 60px; background: #2A2A2A; border-radius: 8px; width: 160px; display: none; box-shadow: 0 5px 15px rgba(0,0,0,0.5); z-index: 100; }
        .dropdown-menu.show { display: block; animation: fadeIn 0.2s; }
        .dropdown-item { padding: 12px 15px; font-size: 14px; cursor: pointer; color: white; border-bottom: 1px solid #333; }

        /* --- Content Area --- */
        .content-area { 
            flex: 1 1 auto; 
            overflow-y: auto; 
            position: relative; 
            min-height: 0; 
            -webkit-overflow-scrolling: touch;
            padding-bottom: 20px; 
        }

        /* --- Footer --- */
        .bottom-nav { 
            background: var(--surface-color); 
            display: flex; 
            flex-direction: column; 
            align-items: center;
            padding-top: 15px;
            padding-bottom: max(15px, var(--safe-bottom)); 
            border-top: 1px solid #333; 
            flex-shrink: 0; 
            z-index: 40;
        }
        .bottom-nav-icons { display: flex; width: 100%; justify-content: space-around; margin-bottom: 10px; }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: var(--text-secondary); font-size: 12px; cursor: pointer; gap: 5px; flex: 1; }
        .nav-item i { font-size: 24px; }
        .nav-item.active { color: var(--primary); }
        .bottom-nav-credit { font-size: 10px; color: #666; letter-spacing: 1px; text-transform: uppercase; width: 100%; text-align: center; padding-top: 5px; border-top: 1px solid #2a2a2a; }
        .bottom-nav-credit a { color: var(--primary); text-decoration: none; font-weight: 700; }

        /* --- Lists --- */
        .list-item { padding: 15px 20px; display: flex; align-items: center; border-bottom: 1px solid #222; cursor: pointer; }
        .avatar { width: 50px; height: 50px; border-radius: 50%; background: #333; margin-right: 15px; object-fit: cover; flex-shrink: 0; }
        .item-info { flex: 1; overflow: hidden; }
        .item-name { font-weight: 600; font-size: 16px; color: white; }
        .item-sub { font-size: 13px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* --- Chat Room UI --- */
        #chat-room { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-color); z-index: 50; display: none; flex-direction: column; }
        #chat-room.active { display: flex; }
        
        .chat-messages { 
            flex: 1; 
            padding: 15px; 
            overflow-y: auto; 
            display: flex; 
            flex-direction: column; 
            gap: 8px; 
            background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); 
            background-blend-mode: soft-light; 
        }

        .message { 
            max-width: 80%; 
            padding: 8px 12px; 
            border-radius: 12px; 
            font-size: 14px; 
            position: relative; 
            word-wrap: break-word; 
            line-height: 1.4;
            display: flex;
            flex-direction: column;
        }
        
        .message.sent { 
            background: var(--message-sent); 
            align-self: flex-end; 
            border-top-right-radius: 0; 
        }
        .message.received { 
            background: var(--message-received); 
            align-self: flex-start; 
            border-top-left-radius: 0; 
        }

        .message-time {
            font-size: 10px;
            color: rgba(255,255,255,0.6);
            align-self: flex-end;
            margin-top: 4px;
        }

        .message img {
            max-width: 100%;
            border-radius: 8px;
            margin-bottom: 5px;
        }

        /* Voice Note Style */
        .voice-note {
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 150px;
        }
        .voice-play-icon { font-size: 20px; color: var(--text-color); }
        .voice-wave { height: 3px; background: rgba(255,255,255,0.3); flex: 1; border-radius: 2px; position: relative; }
        .voice-wave::after { content: ''; position: absolute; left: 0; top: 0; height: 100%; width: 40%; background: var(--primary); }

        /* Input Area */
        .chat-input-area { 
            padding: 8px 10px; 
            padding-bottom: max(8px, var(--safe-bottom)); 
            background: var(--surface-color); 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            flex-shrink: 0; 
        }
        
        .icon-btn { 
            font-size: 20px; 
            color: var(--text-secondary); 
            padding: 8px; 
            cursor: pointer; 
        }
        .icon-btn:hover { color: var(--primary); }

        .chat-input-wrapper {
            flex: 1;
            background: #2a2a2a;
            border-radius: 25px;
            padding: 0 15px;
            display: flex;
            align-items: center;
        }
        
        #message-input {
            background: transparent;
            border: none;
            padding: 12px 0;
            color: white;
            margin: 0;
            width: 100%;
        }
        #message-input:focus { outline: none; }

        .send-btn { 
            background: var(--primary); 
            width: 45px; height: 45px; 
            border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; 
            color: white; 
            flex-shrink: 0; 
            font-size: 18px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .recording-ui {
            flex: 1;
            display: none; /* Toggled via JS */
            align-items: center;
            color: var(--danger);
            font-weight: 600;
            padding-left: 10px;
            animation: pulseRed 1.5s infinite;
        }
        @keyframes pulseRed { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* --- Profile View --- */
        .profile-view { padding: 30px; text-align: center; }
        .profile-label { color: var(--text-secondary); font-size: 12px; margin-bottom: 5px; display: block; text-align: left; margin-top: 15px; }

        /* --- Modal & Toast --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 100; display: none; justify-content: center; align-items: center; }
        .modal-box { background: #222; padding: 25px; border-radius: 15px; width: 85%; max-width: 350px; text-align: center; border: 1px solid #333; }
        .modal-actions { display: flex; gap: 10px; justify-content: center; margin-top: 20px; }
        .btn-modal { padding: 8px 20px; border-radius: 20px; font-size: 14px; }
        .btn-confirm { background: var(--primary); color: white; }
        .btn-cancel { background: #444; color: white; }
        .toast { position: absolute; bottom: 80px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 10px 20px; border-radius: 20px; font-size: 13px; opacity: 0; transition: opacity 0.3s; pointer-events: none; z-index: 200; border: 1px solid var(--primary); width: max-content; }
        .toast.show { opacity: 1; }

    </style>
</head>
<body>

<div id="app-container" class="layout-web">

    <div id="toast" class="toast">Action Completed</div>

    <!-- Confirm Modal -->
    <div id="confirm-modal" class="modal-overlay">
        <div class="modal-box animate-arrival">
            <h3 style="color:white; margin-bottom:10px;" id="modal-title">Confirm</h3>
            <p style="color:#aaa; font-size:14px;" id="modal-text">Are you sure?</p>
            <div class="modal-actions">
                <button class="btn-modal btn-cancel" onclick="closeModal()">Cancel</button>
                <button class="btn-modal btn-confirm" id="modal-confirm-btn">Yes</button>
            </div>
        </div>
    </div>

    <!-- 1. HOME SCREEN (Web View) -->
    <div id="home-screen" class="screen active animate-arrival">
        <div class="hero-section">
            <div class="app-title">NAMASTE</div>
            <div class="tagline">POWERED BY APNA ADDA</div>
        </div>

        <div style="text-align:center; margin-bottom:50px;">
            <button class="btn-primary" style="max-width:300px;" id="get-started-btn" onclick="handleGetStarted()">Get Started</button>
            <div style="margin-top: 20px;">
                <p style="font-size: 12px; color: var(--silver);">Powered by APNA ADDA</p>
                <a href="https://apnaaddatech.github.io/Official_/" target="_blank" style="color: var(--primary); font-size: 12px; text-decoration: none; font-weight: bold;">[ CLICK HERE FOR OFFICIAL WEB ]</a>
            </div>
        </div>

        <div class="highlights-grid">
            <div class="highlight-card">
                <div class="highlight-title"><i class="fas fa-lock"></i> End-to-end Encrypted</div>
                <p class="highlight-desc">Your messages are secured with industry-standard encryption.</p>
            </div>
            <div class="highlight-card">
                <div class="highlight-title"><i class="fas fa-user-shield"></i> 100% Private & Secure</div>
                <p class="highlight-desc">No third-party tracking, strict security protocols to keep data safe.</p>
            </div>
            <div class="highlight-card">
                <div class="highlight-title"><i class="fas fa-bolt"></i> Fast Messaging</div>
                <p class="highlight-desc">Lightning-fast message delivery optimized for performance.</p>
            </div>
            <div class="highlight-card">
                <div class="highlight-title"><i class="fas fa-photo-video"></i> Media Sharing</div>
                <p class="highlight-desc">Share photos and voice notes instantly.</p>
            </div>
        </div>

        <div class="about-section">
            <h3 style="color: white; margin-bottom: 20px; border-bottom: 2px solid var(--primary); display:inline-block; padding-bottom:5px;">About Us</h3>
            <p>APNA ADDA is a technology-driven company committed to building smart, simple, and useful digital solutions for everyday life.</p>
        </div>

        <div class="home-footer">
            <div class="social-row">
                <a href="mailto:thepremanshu@gmail.com" class="social-link"><i class="fas fa-envelope"></i> Contact Us</a>
                <a href="https://t.me/apnaadda_official" target="_blank" class="social-link"><i class="fab fa-telegram"></i> Telegram</a>
                <a href="https://whatsapp.com/channel/0029Vb7K9Ms3gvWeXnfpLy3x" target="_blank" class="social-link"><i class="fab fa-whatsapp"></i> WhatsApp Channel</a>
            </div>
            
            <button id="back-to-chat-btn" onclick="navigateToApp()" class="btn-secondary" style="display: none; width:auto; margin:0;">BACK TO CHAT</button>
            
            <div class="footer-credits">
                DESIGNED BY PREMANSHU KUMAR<br>
                <span style="color: var(--primary);">POWERED BY APNA ADDA</span>
            </div>
        </div>
    </div>

    <!-- 2. AUTH SCREEN -->
    <div id="auth-screen" class="screen">
        <div class="auth-container animate-arrival">
            <div class="hero-section">
                <div class="app-title" style="font-size: 32px;">NAMASTE</div>
                <div class="tagline">Login to Continue</div>
            </div>
            <input type="email" id="auth-email" placeholder="Email Address">
            <input type="password" id="auth-password" placeholder="Password">
            <button class="btn-primary" onclick="login()">Login</button>
            <button class="btn-secondary" onclick="toggleAuthMode()">Create Account</button>
            <p id="auth-msg" style="text-align: center; margin-top: 15px; font-size: 12px; color: var(--danger);"></p>
        </div>
    </div>

    <!-- 3. SETUP SCREEN -->
    <div id="setup-screen" class="screen">
        <div class="auth-container animate-arrival">
            <h2 style="color: white; margin-bottom: 20px; text-align: center;">Profile Setup</h2>
            <div class="dp-preview-wrapper"><img src="" id="setup-dp-preview" class="dp-preview-img"></div>
            <p style="font-size:12px; color:var(--text-secondary); margin-bottom:10px;">Select an Emoji Avatar:</p>
            <div class="emoji-selector" id="setup-emoji-grid"></div>
            <input type="text" id="setup-name" placeholder="Full Name">
            <input type="text" id="setup-username" placeholder="Unique Username ID">
            <button class="btn-primary" id="btn-save-profile" onclick="saveProfile()">Save & Continue</button>
        </div>
    </div>

    <!-- 4. APP SCREEN (MAIN CHAT DASHBOARD) -->
    <div id="app-screen" class="screen">
        <div class="app-header">
            <div>
                <div class="header-title">NAMASTE</div>
                <div class="header-sub">BY APNA ADDA</div>
            </div>
            <div class="more-options" id="menu-btn" onclick="toggleMenu(event)">
                <i class="fas fa-ellipsis-v" style="color: white;"></i>
            </div>
            <div class="dropdown-menu" id="main-menu">
                <div class="dropdown-item" onclick="showBlockedUsers()">Blocked Users</div>
                <div class="dropdown-item" onclick="toggleHomeFooter()">View Home Page</div>
                <div class="dropdown-item" style="color: var(--danger);" onclick="confirmLogout()">Log Out</div>
            </div>
        </div>

        <div id="tab-chats" class="content-area animate-arrival"><div id="chat-list-container"></div></div>
        
        <div id="tab-search" class="content-area" style="display: none;">
            <div style="padding: 20px;">
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="search-input" placeholder="Search by Username ID" style="margin-bottom: 0;">
                    <button class="send-btn" onclick="searchUser()"><i class="fas fa-search"></i></button>
                </div>
                <div id="search-result" style="margin-top: 20px;"></div>
            </div>
        </div>
        
        <!-- Profile Tab -->
        <div id="tab-profile" class="content-area" style="display: none;">
            <div id="profile-view-mode" class="profile-view animate-arrival">
                <div class="dp-preview-wrapper">
                    <img src="" id="view-profile-img" class="dp-preview-img">
                </div>
                <h2 id="view-profile-name" style="color: white; margin-top: 10px;">Name</h2>
                <p id="view-profile-user" style="color: var(--primary); margin-bottom: 30px;">@username</p>
                <button class="btn-primary" onclick="enableEditMode()">Edit Profile</button>
            </div>
            <div id="profile-edit-mode" class="profile-view" style="display: none;">
                <h3 style="color:white; margin-bottom: 20px;">Edit Profile</h3>
                <div class="dp-preview-wrapper"><img src="" id="edit-profile-img" class="dp-preview-img"></div>
                <div style="text-align: left;">
                    <p style="font-size:12px; color:var(--text-secondary); margin-bottom:5px;">Change Avatar:</p>
                    <div class="emoji-selector" id="edit-emoji-grid"></div>
                    <label class="profile-label">Edit Name</label>
                    <input type="text" id="edit-name-input">
                    <label class="profile-label">Edit Username (Must be unique)</label>
                    <input type="text" id="edit-username-input">
                    <button class="btn-primary" id="btn-update-profile" onclick="updateProfile()">Save Changes</button>
                    <button class="btn-cancel-edit" onclick="cancelEditMode()">Cancel</button>
                </div>
            </div>
        </div>

        <!-- FIXED FOOTER -->
        <div class="bottom-nav">
            <div class="bottom-nav-icons">
                <div class="nav-item active" onclick="switchTab('chats', this)"><i class="fas fa-comment-alt"></i><span>Chats</span></div>
                <div class="nav-item" onclick="switchTab('search', this)"><i class="fas fa-search"></i><span>Search</span></div>
                <div class="nav-item" onclick="switchTab('profile', this)"><i class="fas fa-user"></i><span>Profile</span></div>
            </div>
            <div class="bottom-nav-credit">
                POWERED BY <a href="https://apnaaddatech.github.io/Official_/" target="_blank">APNA ADDA</a>
            </div>
        </div>
    </div>

    <!-- Chat Room -->
    <div id="chat-room">
        <div class="chat-header">
            <i class="fas fa-arrow-left" style="color: white; cursor: pointer;" onclick="closeChat()"></i>
            <img src="" id="chat-room-avatar" class="avatar" style="width: 35px; height: 35px; margin: 0;">
            <div style="flex: 1;">
                <div id="chat-room-name" style="color: white; font-weight: 600; font-size: 14px;">User</div>
                <div style="color: var(--primary); font-size: 10px;">End-to-end encrypted</div>
            </div>
            <i class="fas fa-trash" style="color: var(--danger); font-size: 14px; margin-left: 10px; cursor: pointer;" onclick="confirmDeleteChat()"></i>
        </div>
        
        <div id="messages-container" class="chat-messages"></div>
        
        <div class="chat-input-area">
            <!-- Hidden File Input -->
            <input type="file" id="media-input" accept="image/*" hidden onchange="handleMediaUpload(this)">
            
            <i class="fas fa-plus icon-btn" onclick="document.getElementById('media-input').click()"></i>
            
            <div class="chat-input-wrapper">
                <input type="text" id="message-input" placeholder="Message...">
                <div class="recording-ui" id="recording-ui">Recording... 00:01</div>
            </div>
            
            <!-- Dynamic Send/Mic Button -->
            <div class="send-btn" id="action-btn" onclick="handleAction()">
                <i class="fas fa-microphone" id="action-icon"></i>
            </div>
        </div>
    </div>

    <!-- Blocked Users -->
    <div id="blocked-users-screen" class="screen" style="background: var(--bg-color); z-index: 50;">
        <div class="app-header">
            <div style="display: flex; align-items: center; gap: 10px;">
                <i class="fas fa-arrow-left" style="color: white; cursor: pointer;" onclick="closeBlockedScreen()"></i>
                <div class="header-title">Blocked Users</div>
            </div>
        </div>
        <div id="blocked-list" style="padding: 20px;"></div>
    </div>

</div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

<script>
    // --- Config ---
    const firebaseConfig = {
        apiKey: "AIzaSyASV-WrIe0geG86X5cZS5cfVwYv-6mdrUM",
        authDomain: "namaste-989a1.firebaseapp.com",
        databaseURL: "https://namaste-989a1-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "namaste-989a1",
        storageBucket: "namaste-989a1.firebasestorage.app",
        messagingSenderId: "71487251612",
        appId: "1:71487251612:web:cbfe48ace49ca6f9953959"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    let currentUser = null, currentChatId = null, currentChatUser = null, isSignup = false;
    let selectedEmoji = "ðŸ˜Ž"; 
    let currentUserData = null;
    let isRecording = false; // State for voice note

    // Emojis List
    const emojiList = ["ðŸ˜Ž","ðŸ¤ ","ðŸ¤“","ðŸ¥³","ðŸ‘½","ðŸ¤–","ðŸ‘»","ðŸ’€","ðŸ’©","ðŸ¤¡","ðŸ‘¹","ðŸ¯","ðŸ¦","ðŸ­","ðŸ¹","ðŸ°","ðŸ¦Š","ðŸ»","ðŸ¼","ðŸ¨","ðŸ¯","ðŸ¦„","ðŸ²","ðŸ”¥","âš¡","â­","âš½","ðŸ€"];

    const screens = { home: document.getElementById('home-screen'), auth: document.getElementById('auth-screen'), setup: document.getElementById('setup-screen'), app: document.getElementById('app-screen'), blocked: document.getElementById('blocked-users-screen') };
    const appContainer = document.getElementById('app-container');

    // --- Helper: Generate Image ---
    function createEmojiAvatar(emoji) {
        const canvas = document.createElement('canvas'); canvas.width = 200; canvas.height = 200;
        const ctx = canvas.getContext('2d');
        const grd = ctx.createLinearGradient(0, 0, 200, 200);
        grd.addColorStop(0, "#25D366"); grd.addColorStop(1, "#128C7E");
        ctx.fillStyle = grd; ctx.fillRect(0, 0, 200, 200);
        ctx.font = "100px Arial"; ctx.textAlign = "center"; ctx.textBaseline = "middle";
        ctx.fillText(emoji, 100, 100);
        return canvas.toDataURL();
    }

    // --- Init Logic ---
    function initEmojiGrids() {
        const renderGrid = (id, previewId) => {
            const container = document.getElementById(id); container.innerHTML = "";
            emojiList.forEach(e => {
                const btn = document.createElement('div'); btn.className = "emoji-btn"; btn.innerText = e;
                btn.onclick = () => {
                    selectedEmoji = e;
                    document.getElementById(previewId).src = createEmojiAvatar(e);
                    Array.from(container.children).forEach(c => c.classList.remove('selected'));
                    btn.classList.add('selected');
                };
                container.appendChild(btn);
            });
        };
        renderGrid('setup-emoji-grid', 'setup-dp-preview');
        renderGrid('edit-emoji-grid', 'edit-profile-img');
        document.getElementById('setup-dp-preview').src = createEmojiAvatar(selectedEmoji);
    }
    initEmojiGrids();

    // --- Navigation ---
    function showScreen(name) {
        appContainer.className = name === 'home' ? 'layout-web' : 'layout-mobile';
        Object.values(screens).forEach(s => s.classList.remove('active'));
        screens[name].classList.add('active');
    }

    // --- Menu Handling ---
    function toggleMenu(e) { e.stopPropagation(); document.getElementById('main-menu').classList.toggle('show'); }
    window.onclick = function(event) {
        const menu = document.getElementById('main-menu');
        if (menu.classList.contains('show') && !event.target.closest('#menu-btn')) { menu.classList.remove('show'); }
    }
    function closeMenu() { document.getElementById('main-menu').classList.remove('show'); }

    // --- Auth Logic ---
    auth.onAuthStateChanged(user => {
        if (user) {
            currentUser = user;
            db.ref('users/' + user.uid).once('value').then(snap => {
                if (snap.exists()) {
                    currentUserData = snap.val();
                    document.getElementById('back-to-chat-btn').style.display = 'inline-flex';
                    document.getElementById('get-started-btn').innerText = "Back to Chat Area";
                    if(!sessionStorage.getItem('onHome')) { navigateToApp(); showToast("Welcome " + snap.val().name); }
                } else { showScreen('setup'); }
            });
        } else {
            currentUser = null;
            document.getElementById('back-to-chat-btn').style.display = 'none';
            document.getElementById('get-started-btn').innerText = "Get Started";
        }
    });

    function handleGetStarted() { currentUser ? navigateToApp() : showScreen('auth'); }
    function toggleAuthMode() {
        isSignup = !isSignup;
        document.querySelector('#auth-screen .btn-primary').innerText = isSignup ? "Sign Up" : "Login";
        document.querySelector('#auth-screen .btn-secondary').innerText = isSignup ? "Back to Login" : "Create Account";
        document.querySelector('#auth-screen .tagline').innerText = isSignup ? "Create New Account" : "Login to Continue";
    }

    function login() {
        const email = document.getElementById('auth-email').value;
        const pass = document.getElementById('auth-password').value;
        if (!email || !pass) return;
        (isSignup ? auth.createUserWithEmailAndPassword(email, pass) : auth.signInWithEmailAndPassword(email, pass))
            .then(() => { if(isSignup) showScreen('setup'); })
            .catch(e => document.getElementById('auth-msg').innerText = e.message);
    }
    
    function confirmLogout() { showModal("Logout", "Log out now?", () => auth.signOut().then(() => { showScreen('home'); sessionStorage.removeItem('onHome'); closeMenu(); })); }

    // --- Profile Saving ---
    function saveProfile() {
        const name = document.getElementById('setup-name').value;
        const username = document.getElementById('setup-username').value.toLowerCase().replace(/\s/g, '');
        const btn = document.getElementById('btn-save-profile');
        if (!name || !username) { alert("Name & Username required"); return; }

        db.ref('usernames/' + username).once('value').then(snap => {
            if(snap.exists()) { alert("Username already taken!"); return; }
            btn.innerText = "Creating..."; btn.disabled = true;
            const photoURL = createEmojiAvatar(selectedEmoji);
            const updates = {
                ['users/' + currentUser.uid]: { name, username, photo: photoURL, email: currentUser.email, uid: currentUser.uid },
                ['usernames/' + username]: currentUser.uid
            };
            db.ref().update(updates).then(() => {
                btn.innerText = "Save & Continue"; btn.disabled = false;
                navigateToApp(); showToast("Profile Created!");
            });
        });
    }

    // --- Profile Editing ---
    function loadProfile() {
        db.ref('users/' + currentUser.uid).once('value').then(s => {
            currentUserData = s.val();
            document.getElementById('view-profile-name').innerText = currentUserData.name;
            document.getElementById('view-profile-user').innerText = "@" + currentUserData.username;
            document.getElementById('view-profile-img').src = currentUserData.photo;
            
            document.getElementById('edit-name-input').value = currentUserData.name;
            document.getElementById('edit-username-input').value = currentUserData.username;
            document.getElementById('edit-profile-img').src = currentUserData.photo;
        });
    }

    function enableEditMode() {
        document.getElementById('profile-view-mode').style.display = 'none';
        document.getElementById('profile-edit-mode').style.display = 'block';
    }

    function cancelEditMode() {
        document.getElementById('profile-edit-mode').style.display = 'none';
        document.getElementById('profile-view-mode').style.display = 'block';
    }

    function updateProfile() {
        const newName = document.getElementById('edit-name-input').value;
        const newUsername = document.getElementById('edit-username-input').value.toLowerCase().replace(/\s/g, '');
        const btn = document.getElementById('btn-update-profile');
        if(!newName || !newUsername) { alert("Fields cannot be empty"); return; }

        showModal("Update Profile", "Save these changes?", () => {
            btn.innerText = "Updating..."; btn.disabled = true;
            const newPhoto = createEmojiAvatar(selectedEmoji);
            
            const processUpdate = () => {
                 const updates = { ['users/' + currentUser.uid + '/name']: newName, ['users/' + currentUser.uid + '/photo']: newPhoto };
                 if(newUsername !== currentUserData.username) {
                     updates['users/' + currentUser.uid + '/username'] = newUsername;
                     updates['usernames/' + currentUserData.username] = null;
                     updates['usernames/' + newUsername] = currentUser.uid;
                 }
                 db.ref().update(updates).then(() => {
                     showToast("Profile Updated"); btn.innerText = "Save Changes"; btn.disabled = false;
                     loadProfile(); cancelEditMode();
                 });
            };

            if (newUsername !== currentUserData.username) {
                db.ref('usernames/' + newUsername).once('value').then(snap => {
                    if (snap.exists()) { alert("Username taken."); btn.innerText = "Save Changes"; btn.disabled = false; }
                    else { processUpdate(); }
                });
            } else { processUpdate(); }
        });
    }

    // --- Main App Logic ---
    function navigateToApp() { sessionStorage.removeItem('onHome'); showScreen('app'); loadChats(); loadProfile(); }
    function toggleHomeFooter() { sessionStorage.setItem('onHome', 'true'); showScreen('home'); closeMenu(); }
    function switchTab(name, el) {
        document.querySelectorAll('.content-area').forEach(d => d.style.display = 'none');
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        document.getElementById('tab-' + name).style.display = 'block'; el.classList.add('active');
        if(name==='chats') loadChats(); if(name==='profile') { loadProfile(); cancelEditMode(); }
    }

    // --- Chat/Search ---
    function searchUser() {
        const q = document.getElementById('search-input').value.toLowerCase();
        const res = document.getElementById('search-result');
        res.innerHTML = "Searching...";
        db.ref('usernames/' + q).once('value').then(s => {
            if(s.exists()){
                const uid = s.val();
                if(uid === currentUser.uid) { res.innerHTML = "That's you!"; return; }
                db.ref('users/'+uid).once('value').then(us => {
                    const u = us.val();
                    res.innerHTML = `<div class="list-item" style="background:#222; border-radius:10px;"><img src="${u.photo}" class="avatar"><div class="item-info"><div class="item-name">${u.name}</div><span class="item-sub">@${u.username}</span></div><button class="btn-primary" style="width:auto; padding:8px 15px; font-size:12px;" onclick="openChat('${u.uid}','${u.name}','${u.photo}')">Message</button></div>`;
                });
            } else { res.innerHTML = "User not found"; }
        });
    }

    function openChat(uid, name, photo) {
        currentChatUser = { uid, name, photo };
        currentChatId = currentUser.uid < uid ? currentUser.uid + "_" + uid : uid + "_" + currentUser.uid;
        document.getElementById('chat-room').classList.add('active');
        document.getElementById('chat-room-name').innerText = name;
        document.getElementById('chat-room-avatar').src = photo;
        const c = document.getElementById('messages-container'); c.innerHTML = "";
        db.ref('chats/' + currentChatId + '/messages').off();
        db.ref('chats/' + currentChatId + '/messages').on('child_added', s => appendMessage(s.val()));
    }

    // --- Message Rendering ---
    function appendMessage(m) {
        const c = document.getElementById('messages-container');
        const d = document.createElement('div');
        d.className = `message ${m.sender === currentUser.uid ? 'sent' : 'received'}`;
        
        let contentHtml = "";
        if (m.type === 'image') {
            contentHtml = `<img src="${m.text}">`;
        } else if (m.type === 'voice') {
            contentHtml = `<div class="voice-note"><i class="fas fa-play-circle voice-play-icon"></i><div class="voice-wave"></div><span style="font-size:10px; opacity:0.7">0:05</span></div>`;
        } else {
            contentHtml = m.text;
        }

        const time = new Date(m.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        d.innerHTML = `${contentHtml}<span class="message-time">${time}</span>`;
        
        d.onclick = () => { if(m.sender === currentUser.uid) showModal("Delete", "Delete message?", () => { d.style.display='none'; showToast("Deleted"); }); };
        c.appendChild(d); c.scrollTop = c.scrollHeight;
    }

    // --- Media & Voice Handling ---
    function handleMediaUpload(input) {
        const file = input.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                pushMessage(e.target.result, 'image', "Photo Sent");
            };
            reader.readAsDataURL(file);
        }
    }

    // Update Input UI based on typing
    document.getElementById('message-input').addEventListener('input', function() {
        const icon = document.getElementById('action-icon');
        if (this.value.trim().length > 0) {
            icon.className = "fas fa-paper-plane"; // Send Icon
        } else {
            icon.className = "fas fa-microphone"; // Mic Icon
        }
    });

    function handleAction() {
        const input = document.getElementById('message-input');
        const text = input.value.trim();

        if (text.length > 0) {
            // Send Text
            pushMessage(text, 'text', text);
            input.value = "";
            document.getElementById('action-icon').className = "fas fa-microphone";
        } else {
            // Handle Voice Recording Toggle
            if (!isRecording) {
                isRecording = true;
                document.getElementById('message-input').style.display = 'none';
                document.getElementById('recording-ui').style.display = 'flex';
                document.getElementById('action-icon').className = "fas fa-stop";
            } else {
                isRecording = false;
                document.getElementById('message-input').style.display = 'block';
                document.getElementById('recording-ui').style.display = 'none';
                document.getElementById('action-icon').className = "fas fa-microphone";
                // Send simulated voice note
                pushMessage("Voice Note", 'voice', "Voice Message");
            }
        }
    }

    function pushMessage(content, type, lastMsgPreview) {
        db.ref(`users/${currentChatUser.uid}/blocked`).once('value').then(snap => {
            if(snap.exists() && Object.values(snap.val()).includes(currentUser.uid)) { showToast("Cannot message this user"); return; }
            
            db.ref('chats/' + currentChatId + '/messages').push({ 
                sender: currentUser.uid, 
                text: content, 
                type: type,
                timestamp: Date.now() 
            });
            
            const upd = {};
            upd[`userChats/${currentUser.uid}/${currentChatId}`] = { withUser: currentChatUser.uid, lastMsg: lastMsgPreview, time: Date.now() };
            upd[`userChats/${currentChatUser.uid}/${currentChatId}`] = { withUser: currentUser.uid, lastMsg: lastMsgPreview, time: Date.now() };
            db.ref().update(upd);
        });
    }

    function loadChats() {
        const c = document.getElementById('chat-list-container'); c.innerHTML = "";
        db.ref('userChats/' + currentUser.uid).once('value').then(s => {
            if(!s.exists()) { c.innerHTML = "<p style='text-align:center;color:grey;margin-top:20px;'>No chats.</p>"; return; }
            s.forEach(ch => {
                const v = ch.val();
                db.ref('users/'+v.withUser).once('value').then(u => {
                    const usr = u.val();
                    const tm = new Date(v.time).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
                    const div = document.createElement('div'); div.className = "list-item animate-arrival";
                    div.innerHTML = `<img src="${usr.photo}" class="avatar"><div class="item-info"><div class="item-name">${usr.name}</div><span class="item-sub">${v.lastMsg}</span></div><div class="item-meta">${tm}</div><i class="fas fa-trash delete-btn" onclick="event.stopPropagation();deleteEntireChat('${ch.key}')"></i>`;
                    div.onclick = () => openChat(usr.uid, usr.name, usr.photo);
                    c.appendChild(div);
                });
            });
        });
    }

    // --- Blocking/Calls/Util ---
    function blockCurrentUser() { showModal("Block", "Block user?", () => db.ref(`users/${currentUser.uid}/blocked`).push(currentChatUser.uid).then(() => { showToast("Blocked"); closeChat(); })); }
    document.getElementById('chat-room-avatar').onclick = () => showModal("Options", "Block user?", blockCurrentUser);
    function showBlockedUsers() { closeMenu(); showScreen('blocked'); const l = document.getElementById('blocked-list'); l.innerHTML=""; db.ref(`users/${currentUser.uid}/blocked`).once('value').then(s => { if(!s.exists()) { l.innerHTML="<p style='color:grey;text-align:center'>Empty</p>"; return; } s.forEach(b => db.ref('users/'+b.val()).once('value').then(u => l.innerHTML += `<div class="list-item"><img src="${u.val().photo}" class="avatar"><div class="item-info">${u.val().name}</div><button class="btn-secondary" style="width:auto;padding:5px 10px;font-size:12px" onclick="unblockUser('${b.key}')">Unblock</button></div>`)); }); }
    function unblockUser(k) { db.ref(`users/${currentUser.uid}/blocked/${k}`).remove().then(() => { showBlockedUsers(); showToast("Unblocked"); }); }

    // --- Utils ---
    function closeChat() { document.getElementById('chat-room').classList.remove('active'); loadChats(); }
    function closeBlockedScreen() { showScreen('app'); }
    function deleteEntireChat(id) { showModal("Delete", "Delete Chat?", () => db.ref(`userChats/${currentUser.uid}/${id}`).remove().then(() => { loadChats(); showToast("Deleted"); })); }
    function confirmDeleteChat() { deleteEntireChat(currentChatId); closeChat(); }
    
    let confirmCB = null;
    function showModal(t, txt, cb) { document.getElementById('modal-title').innerText=t; document.getElementById('modal-text').innerText=txt; document.getElementById('confirm-modal').style.display='flex'; confirmCB=cb; }
    function closeModal() { document.getElementById('confirm-modal').style.display='none'; confirmCB=null; }
    document.getElementById('modal-confirm-btn').onclick = () => { if(confirmCB) confirmCB(); closeModal(); };
    function showToast(m) { const t=document.getElementById('toast'); t.innerText=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 3000); }
</script>
</body>
    </html>
