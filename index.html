<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NAMASTE - Powered by APNA ADDA</title>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary: #00e676; /* Light Green */
            --primary-dark: #00b248;
            --bg-color: #000000; /* Black */
            --card-bg: #121212; /* Dark Grey */
            --text-main: #ffffff; /* White */
            --text-sec: #b0bec5; /* Silver/Grey */
            --danger: #ff1744; /* Red */
            --border: #333333;
            --font: 'Poppins', sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: var(--font); background-color: var(--bg-color); color: var(--text-main); overflow-x: hidden; height: 100vh; display: flex; flex-direction: column; }

        /* --- Animations --- */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        .animate-entry { animation: fadeIn 0.6s ease-out forwards; }
        .hidden { display: none !important; }

        /* --- Common UI Components --- */
        button { cursor: pointer; font-family: var(--font); border: none; outline: none; transition: 0.3s; }
        
        .btn-primary {
            background-color: var(--primary); color: #000; font-weight: 700;
            padding: 12px 24px; border-radius: 30px; font-size: 1rem; width: 100%;
            box-shadow: 0 4px 15px rgba(0, 230, 118, 0.4);
        }
        .btn-primary:active { transform: scale(0.98); }

        .btn-outline {
            background: transparent; border: 2px solid var(--primary); color: var(--primary);
            font-weight: 600; padding: 12px 24px; border-radius: 30px; width: 100%; margin-top: 10px;
        }

        .btn-danger { background-color: var(--danger); color: white; }

        input {
            width: 100%; background: var(--card-bg); border: 1px solid var(--border);
            color: white; padding: 15px; border-radius: 12px; margin-bottom: 15px;
            font-size: 1rem; outline: none;
        }
        input:focus { border-color: var(--primary); }

        /* --- Screens --- */
        .screen { width: 100%; height: 100%; display: flex; flex-direction: column; overflow-y: auto; position: absolute; top: 0; left: 0; background: var(--bg-color); }

        /* 1. Home Screen */
        #home-screen { padding: 20px; text-align: center; }
        .hero-title { font-size: 2.5rem; font-weight: 800; letter-spacing: 2px; color: var(--text-main); margin-top: 40px; }
        .hero-subtitle { color: var(--primary); font-size: 0.9rem; letter-spacing: 1px; margin-bottom: 30px; font-weight: 600; text-transform: uppercase; }
        
        .feature-card { background: var(--card-bg); padding: 15px; border-radius: 15px; margin-bottom: 15px; text-align: left; border-left: 4px solid var(--primary); }
        .feature-card h3 { color: var(--primary); font-size: 1.1rem; margin-bottom: 5px; }
        .feature-card p { font-size: 0.85rem; color: var(--text-sec); line-height: 1.4; }
        .feature-card a { color: var(--primary); text-decoration: underline; }

        .about-section { margin-top: 30px; text-align: left; background: #1a1a1a; padding: 20px; border-radius: 15px; }
        .about-section h2 { color: var(--primary); margin-bottom: 10px; }
        .about-section p { font-size: 0.85rem; color: var(--text-sec); margin-bottom: 10px; line-height: 1.5; }

        .footer { margin-top: 40px; padding-bottom: 20px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;}
        .footer-btn { display: flex; align-items: center; gap: 8px; padding: 10px 20px; border-radius: 20px; background: #222; color: white; text-decoration: none; font-size: 0.8rem; border: 1px solid #333; }
        .footer-btn i { color: var(--primary); }

        /* 2. Auth & Setup */
        .auth-container { display: flex; flex-direction: column; justify-content: center; height: 100%; padding: 30px; }
        .emoji-picker { font-size: 3rem; text-align: center; margin: 20px 0; cursor: pointer; border: 2px dashed var(--border); border-radius: 50%; width: 100px; height: 100px; line-height: 90px; margin-left: auto; margin-right: auto; }

        /* 3. Main App Layout */
        #main-app { display: flex; flex-direction: column; height: 100vh; }
        
        .app-header {
            padding: 15px 20px; background: rgba(10,10,10,0.95); border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center; z-index: 100;
        }
        .app-logo { font-weight: 800; font-size: 1.2rem; }
        .app-logo span { color: var(--primary); font-size: 0.8rem; display: block; font-weight: 400; }
        
        .header-actions { position: relative; }
        .dropdown-menu {
            position: absolute; right: 0; top: 30px; background: var(--card-bg); border: 1px solid var(--border);
            border-radius: 8px; width: 180px; display: none; flex-direction: column; box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        .dropdown-menu.show { display: flex; }
        .dropdown-item { padding: 12px; font-size: 0.9rem; color: white; cursor: pointer; border-bottom: 1px solid #222; }
        .dropdown-item:hover { background: #222; }
        
        .content-area { flex: 1; overflow-y: auto; padding-bottom: 70px; }

        /* Tabs */
        .bottom-nav {
            position: fixed; bottom: 0; width: 100%; background: var(--card-bg); border-top: 1px solid var(--border);
            display: flex; justify-content: space-around; padding: 10px 0; z-index: 100;
        }
        .nav-item { color: var(--text-sec); text-align: center; font-size: 0.7rem; cursor: pointer; }
        .nav-item i { font-size: 1.3rem; display: block; margin-bottom: 4px; transition: 0.2s; }
        .nav-item.active { color: var(--primary); }
        .nav-item.active i { transform: translateY(-3px); }

        /* Lists (Chats/Search) */
        .user-list-item {
            display: flex; align-items: center; padding: 15px; border-bottom: 1px solid #222; cursor: pointer; transition: background 0.2s;
        }
        .user-list-item:active { background: #1a1a1a; }
        .avatar { width: 50px; height: 50px; background: #333; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; margin-right: 15px; border: 2px solid var(--primary); }
        .user-info { flex: 1; }
        .user-name { font-weight: 600; color: white; font-size: 1rem; }
        .user-meta { font-size: 0.8rem; color: var(--text-sec); margin-top: 3px; display: flex; justify-content: space-between; }
        .delete-chat-btn { color: var(--danger); background: none; border: none; font-size: 1rem; padding: 5px; margin-left: 10px; }

        /* Chat Room */
        #chat-room { z-index: 200; background: var(--bg-color); }
        .chat-header {
            padding: 10px 15px; background: var(--card-bg); display: flex; align-items: center; border-bottom: 1px solid var(--border);
        }
        .back-btn { font-size: 1.2rem; color: white; margin-right: 15px; cursor: pointer; }
        .chat-title { display: flex; align-items: center; flex: 1; cursor: pointer;}
        .chat-title .avatar { width: 40px; height: 40px; font-size: 1.2rem; margin-right: 10px; }
        
        .messages-container { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .message { max-width: 75%; padding: 10px 15px; border-radius: 15px; font-size: 0.95rem; position: relative; word-wrap: break-word; animation: fadeIn 0.3s; }
        .msg-sent { align-self: flex-end; background: var(--primary); color: #000; border-bottom-right-radius: 2px; }
        .msg-received { align-self: flex-start; background: #333; color: white; border-bottom-left-radius: 2px; }
        .msg-media img, .msg-media video { max-width: 100%; border-radius: 10px; margin-top: 5px; }
        .msg-time { font-size: 0.65rem; opacity: 0.7; display: block; text-align: right; margin-top: 4px; }
        .msg-delete { position: absolute; top: -5px; right: -5px; background: var(--danger); color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 10px; display: none; align-items: center; justify-content: center; cursor: pointer;}
        .message:hover .msg-delete { display: flex; }

        .chat-input-area {
            padding: 10px; background: var(--card-bg); display: flex; align-items: center; gap: 10px;
        }
        .chat-action-btn { color: var(--primary); font-size: 1.3rem; padding: 8px; cursor: pointer; }
        .chat-input { flex: 1; background: #222; border: none; border-radius: 20px; color: white; padding: 10px 15px; margin: 0; }

        /* Modals & Toasts */
        .toast {
            position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%);
            background: rgba(50, 50, 50, 0.9); color: white; padding: 10px 20px; border-radius: 20px;
            font-size: 0.9rem; opacity: 0; transition: 0.3s; pointer-events: none; z-index: 1000;
        }
        .toast.show { opacity: 1; bottom: 90px; }

        .confirm-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8);
            z-index: 300; display: none; align-items: center; justify-content: center;
        }
        .confirm-box { background: var(--card-bg); padding: 25px; border-radius: 15px; width: 85%; max-width: 350px; text-align: center; border: 1px solid var(--border); }
        .confirm-box h3 { margin-bottom: 10px; color: white; }
        .confirm-box p { color: var(--text-sec); margin-bottom: 20px; font-size: 0.9rem; }
        .confirm-actions { display: flex; gap: 10px; }
        
        .profile-view-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-color);
            z-index: 250; display: none; flex-direction: column; padding: 20px;
        }

    </style>
</head>
<body>

    <!-- Notification Toast -->
    <div id="toast" class="toast">Notification</div>

    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="confirm-overlay">
        <div class="confirm-box">
            <h3 id="confirm-title">Confirm</h3>
            <p id="confirm-msg">Are you sure?</p>
            <div class="confirm-actions">
                <button class="btn-outline" onclick="closeConfirm()">Cancel</button>
                <button class="btn-primary btn-danger" id="confirm-yes-btn">Yes</button>
            </div>
        </div>
    </div>

    <!-- 1. HOME SCREEN -->
    <div id="home-screen" class="screen animate-entry">
        <h1 class="hero-title">NAMASTE</h1>
        <p class="hero-subtitle">POWERED BY APNA ADDA</p>
        
        <button id="get-started-btn" class="btn-primary" onclick="handleGetStarted()">Get Started</button>

        <div style="margin-top: 30px;">
            <div class="feature-card">
                <h3>End-to-end encrypted (Simulated)</h3>
                <p>We use standard secure transport layer security. Your messages are stored securely. 100% private & secure environment for your conversations.</p>
            </div>
            <div class="feature-card">
                <h3>Fast messaging</h3>
                <p>Real-time data transmission ensures your texts, photos, and videos are delivered instantly without delay.</p>
            </div>
            <div class="feature-card">
                <h3>Media sharing supported</h3>
                <p>Share your moments with friends. Send Photos, Videos and Voice messages seamlessly within the chat room.</p>
            </div>
            <div class="feature-card">
                <h3>Powered by APNA ADDA</h3>
                <p>Technology for everyday growth. <a href="https://apnaaddatech.github.io/Official_/" target="_blank">WRITE CLICK HERE FOR OFFICIAL WEB</a></p>
            </div>
        </div>

        <div class="about-section">
            <h2>About Us</h2>
            <p>APNA ADDA is a technology-driven company committed to building smart, simple, and useful digital solutions for everyday life. We primarily focus on creating applications that support students, while also offering tools that benefit people from all walks of life.</p>
            <p>Our apps are designed to make daily tasks easier, improve productivity, and provide practical solutions through modern technology. At APNA ADDA, we believe that technology should be accessible, reliable, and purpose-driven.</p>
            <p>The company was founded and is owned by Premanshu Kumar, a passionate developer focused on creating meaningful digital products that solve real-world problems. This official website of APNA ADDA represents our mission, our products, and our commitment to quality and innovation.</p>
            <p>We continuously work to improve our applications and introduce new ideas that can make a positive impact on education and daily living.</p>
            <p><strong>APNA ADDA â€“ Technology for Everyday Growth.</strong></p>
        </div>

        <div class="footer">
            <a href="mailto:thepremanshu@gmail.com" class="footer-btn"><i class="fas fa-envelope"></i> Contact Us</a>
            <a href="https://t.me/apnaadda_official" target="_blank" class="footer-btn"><i class="fab fa-telegram"></i> Telegram</a>
        </div>
    </div>

    <!-- 2. AUTH SCREEN -->
    <div id="auth-screen" class="screen hidden">
        <div class="auth-container">
            <h2 class="hero-title" style="margin-top:0">Welcome</h2>
            <p class="hero-subtitle">Log in to NAMASTE</p>
            
            <div id="auth-forms">
                <!-- Login Form -->
                <div id="login-form">
                    <input type="email" id="login-email" placeholder="Email Address">
                    <input type="password" id="login-pass" placeholder="Password">
                    <button class="btn-primary" onclick="login()">Login</button>
                    <button class="btn-outline" onclick="toggleAuthMode()">Create Account</button>
                </div>
                
                <!-- Signup Form -->
                <div id="signup-form" class="hidden">
                    <input type="email" id="signup-email" placeholder="Email Address">
                    <input type="password" id="signup-pass" placeholder="Password">
                    <button class="btn-primary" onclick="signup()">Sign Up</button>
                    <button class="btn-outline" onclick="toggleAuthMode()">Back to Login</button>
                </div>
            </div>
            <button class="btn-outline" style="border:none; margin-top: 20px; color: #666;" onclick="showScreen('home-screen')">Back Home</button>
        </div>
    </div>

    <!-- 3. PROFILE SETUP SCREEN -->
    <div id="setup-screen" class="screen hidden">
        <div class="auth-container">
            <h2 style="color:white; margin-bottom:20px;">Profile Setup</h2>
            <div class="emoji-picker" id="setup-emoji-disp" onclick="cycleEmoji()">ðŸ˜Ž</div>
            <p style="text-align:center; color:gray; font-size:0.8rem; margin-bottom:20px;">Tap emoji to change</p>
            
            <input type="text" id="setup-name" placeholder="Full Name">
            <input type="text" id="setup-username" placeholder="Unique Username ID">
            
            <button class="btn-primary" onclick="saveProfile()">Save & Continue</button>
        </div>
    </div>

    <!-- 4. MAIN APP SCREEN -->
    <div id="main-app-screen" class="screen hidden">
        <div id="main-app">
            <!-- Header -->
            <header class="app-header">
                <div class="app-logo">NAMASTE <span>BY APNA ADDA</span></div>
                <div class="header-actions">
                    <i class="fas fa-ellipsis-v" style="color:white; padding:10px; cursor:pointer;" onclick="toggleMainMenu()"></i>
                    <div id="main-menu" class="dropdown-menu">
                        <div class="dropdown-item" onclick="showBlockedList()">Blocked Users</div>
                        <div class="dropdown-item" onclick="showScreen('home-screen')">Home Page</div>
                        <div class="dropdown-item" onclick="logout()" style="color:var(--danger)">Logout</div>
                    </div>
                </div>
            </header>

            <!-- Content Area -->
            <div class="content-area" id="tab-content">
                <!-- Chat List Tab -->
                <div id="tab-chats">
                    <div style="padding:15px; color:gray; font-size:0.8rem;" id="chat-list-container">
                        Loading chats...
                    </div>
                </div>

                <!-- Search Tab -->
                <div id="tab-search" class="hidden" style="padding:15px;">
                    <input type="text" id="search-input" placeholder="Search by Username ID..." onkeyup="handleSearch()">
                    <div id="search-results"></div>
                </div>

                <!-- Profile Tab -->
                <div id="tab-profile" class="hidden" style="padding:20px; text-align:center;">
                    <div class="emoji-picker" id="my-profile-emoji" onclick="editProfileEmoji()"></div>
                    <input type="text" id="edit-name" placeholder="Full Name">
                    <input type="text" id="edit-username" placeholder="Username" readonly style="opacity: 0.7;">
                    <button class="btn-primary" onclick="updateProfile()">Update Profile</button>
                </div>
                
                <!-- Blocked Users View (Dynamically Injected) -->
                <div id="tab-blocked" class="hidden" style="padding:15px;">
                    <h3 style="color:white; margin-bottom:15px;">Blocked Users</h3>
                    <div id="blocked-list-container"></div>
                    <button class="btn-outline" onclick="switchTab('chats')">Back to Chats</button>
                </div>
            </div>

            <!-- Bottom Nav -->
            <div class="bottom-nav">
                <div class="nav-item active" onclick="switchTab('chats')" id="nav-chats">
                    <i class="fas fa-comment-alt"></i> Chats
                </div>
                <div class="nav-item" onclick="switchTab('search')" id="nav-search">
                    <i class="fas fa-search"></i> Search
                </div>
                <div class="nav-item" onclick="switchTab('profile')" id="nav-profile">
                    <i class="fas fa-user"></i> Profile
                </div>
            </div>
        </div>
    </div>

    <!-- 5. CHAT ROOM SCREEN -->
    <div id="chat-room" class="screen hidden">
        <header class="chat-header">
            <i class="fas fa-arrow-left back-btn" onclick="closeChat()"></i>
            <div class="chat-title" onclick="viewChatProfile()">
                <div class="avatar" id="chat-header-emoji"></div>
                <div>
                    <div class="user-name" id="chat-header-name">User</div>
                </div>
            </div>
            <div class="header-actions">
                <i class="fas fa-ellipsis-v" style="color:white; padding:10px; cursor:pointer;" onclick="toggleChatMenu()"></i>
                <div id="chat-menu" class="dropdown-menu">
                    <div class="dropdown-item" onclick="blockCurrentUser()">Block User</div>
                    <div class="dropdown-item" onclick="deleteCurrentChat()" style="color:var(--danger)">Delete Chat</div>
                </div>
            </div>
        </header>

        <div class="messages-container" id="messages-list">
            <!-- Messages go here -->
        </div>

        <div class="chat-input-area" id="chat-input-area">
            <input type="file" id="media-input" style="display:none;" accept="image/*,video/*" onchange="handleFileSelect(this)">
            <i class="fas fa-paperclip chat-action-btn" onclick="document.getElementById('media-input').click()"></i>
            
            <input type="text" class="chat-input" id="message-input" placeholder="Type a message...">
            
            <i class="fas fa-microphone chat-action-btn" id="mic-btn" onmousedown="startRecording()" onmouseup="stopRecording()" ontouchstart="startRecording()" ontouchend="stopRecording()"></i>
            <i class="fas fa-paper-plane chat-action-btn" onclick="sendTextMessage()"></i>
        </div>
        <div id="blocked-msg-bar" style="background:#222; color:red; text-align:center; padding:10px; display:none; font-size:0.8rem;">
            You cannot reply to this conversation.
        </div>
    </div>

    <!-- User Profile Preview Modal -->
    <div id="profile-preview" class="profile-view-modal">
        <button class="btn-outline" style="width: auto; align-self: flex-start; margin-bottom: 20px;" onclick="document.getElementById('profile-preview').style.display='none'">Back</button>
        <div style="text-align:center; margin-top: 50px;">
            <div class="avatar" id="preview-emoji" style="width:100px; height:100px; font-size:3rem; margin: 0 auto 20px;"></div>
            <h2 id="preview-name" style="color:white;"></h2>
            <p id="preview-username" style="color:var(--primary); margin-bottom: 30px;"></p>
        </div>
    </div>

    <!-- FIREBASE & LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, set, get, child, onValue, push, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        // Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyASV-WrIe0geG86X5cZS5cfVwYv-6mdrUM",
            authDomain: "namaste-989a1.firebaseapp.com",
            databaseURL: "https://namaste-989a1-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "namaste-989a1",
            storageBucket: "namaste-989a1.firebasestorage.app",
            messagingSenderId: "71487251612",
            appId: "1:71487251612:web:cbfe48ace49ca6f9953959"
        };

        // Initialize
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        const storage = getStorage(app);

        // State
        let currentUser = null;
        let currentChatId = null;
        let currentChatUser = null; // Object {uid, name, emoji}
        let emojis = ["ðŸ˜Ž", "ðŸ˜Š", "ðŸš€", "ðŸ¦", "ðŸ¼", "ðŸ”¥", "ðŸ’Ž", "ðŸ‘½", "ðŸ¤–", "ðŸ‘»"];
        let currentEmojiIdx = 0;
        let mediaRecorder;
        let audioChunks = [];

        // --- AUTH LOGIC ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                // Check if profile exists
                get(child(ref(db), `users/${user.uid}`)).then((snapshot) => {
                    if (snapshot.exists()) {
                        document.getElementById('get-started-btn').innerText = "BACK TO CHAT AREA";
                        // If we are on home or auth, go to main. If refreshing, stay where suitable.
                        // Simple logic: If just opened, go to main.
                        if(!document.getElementById('home-screen').classList.contains('hidden') && sessionStorage.getItem('visited')) {
                             showScreen('main-app-screen');
                             loadChats();
                        }
                    } else {
                        showScreen('setup-screen');
                    }
                });
                showToast(`Welcome back`);
            } else {
                currentUser = null;
                document.getElementById('get-started-btn').innerText = "Get Started";
            }
        });

        window.handleGetStarted = () => {
            if (currentUser) {
                showScreen('main-app-screen');
                loadChats();
                sessionStorage.setItem('visited', 'true');
            } else {
                showScreen('auth-screen');
            }
        };

        window.login = () => {
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-pass').value;
            signInWithEmailAndPassword(auth, email, pass)
                .then(() => showScreen('main-app-screen'))
                .catch((e) => showToast(e.message));
        };

        window.signup = () => {
            const email = document.getElementById('signup-email').value;
            const pass = document.getElementById('signup-pass').value;
            createUserWithEmailAndPassword(auth, email, pass)
                .then(() => showScreen('setup-screen'))
                .catch((e) => showToast(e.message));
        };

        window.logout = () => {
            confirmAction("Logout", "Are you sure you want to logout?", () => {
                signOut(auth).then(() => {
                    showScreen('home-screen');
                    showToast("Logged out successfully");
                    sessionStorage.removeItem('visited');
                });
            });
        };

        window.toggleAuthMode = () => {
            document.getElementById('login-form').classList.toggle('hidden');
            document.getElementById('signup-form').classList.toggle('hidden');
        };

        // --- PROFILE LOGIC ---
        window.cycleEmoji = () => {
            currentEmojiIdx = (currentEmojiIdx + 1) % emojis.length;
            document.getElementById('setup-emoji-disp').innerText = emojis[currentEmojiIdx];
        };

        window.saveProfile = () => {
            const name = document.getElementById('setup-name').value;
            const username = document.getElementById('setup-username').value.trim();
            const emoji = emojis[currentEmojiIdx];

            if (!name || !username) return showToast("Please fill all fields");

            // Check username uniqueness
            get(child(ref(db), `usernames/${username}`)).then((snapshot) => {
                if (snapshot.exists()) {
                    showToast("Username already taken!");
                } else {
                    const updates = {};
                    updates[`users/${currentUser.uid}`] = { name, username, emoji, email: currentUser.email };
                    updates[`usernames/${username}`] = currentUser.uid;
                    update(ref(db), updates).then(() => {
                        showScreen('main-app-screen');
                        showToast("Profile Setup Done");
                    });
                }
            });
        };

        window.editProfileEmoji = () => {
            currentEmojiIdx = (currentEmojiIdx + 1) % emojis.length;
            document.getElementById('my-profile-emoji').innerText = emojis[currentEmojiIdx];
        }

        window.updateProfile = () => {
            const name = document.getElementById('edit-name').value;
            const emoji = document.getElementById('my-profile-emoji').innerText;
            
            confirmAction("Update Profile", "Save changes?", () => {
                update(ref(db, `users/${currentUser.uid}`), { name, emoji }).then(() => {
                    showToast("Profile Updated Done");
                });
            });
        };

        // --- MAIN APP NAVIGATION ---
        window.showScreen = (screenId) => {
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            document.getElementById(screenId).classList.remove('hidden');
            // Reset menus
            document.getElementById('main-menu').classList.remove('show');
            
            if (screenId === 'main-app-screen') {
                // Determine active tab
                // Default to chats
                switchTab('chats');
                // Load own profile for edit tab
                get(child(ref(db), `users/${currentUser.uid}`)).then((snap) => {
                    const u = snap.val();
                    document.getElementById('edit-name').value = u.name;
                    document.getElementById('edit-username').value = u.username;
                    document.getElementById('my-profile-emoji').innerText = u.emoji;
                });
            }
        };

        window.switchTab = (tab) => {
            ['chats', 'search', 'profile', 'blocked'].forEach(t => {
                document.getElementById(`tab-${t}`).classList.add('hidden');
                if(document.getElementById(`nav-${t}`)) document.getElementById(`nav-${t}`).classList.remove('active');
            });
            document.getElementById(`tab-${tab}`).classList.remove('hidden');
            if(document.getElementById(`nav-${tab}`)) document.getElementById(`nav-${tab}`).classList.add('active');
            
            if (tab === 'chats') loadChats();
        };

        window.toggleMainMenu = () => document.getElementById('main-menu').classList.toggle('show');

        // --- SEARCH & START CHAT ---
        window.handleSearch = () => {
            const query = document.getElementById('search-input').value.trim();
            if (query.length < 1) {
                 document.getElementById('search-results').innerHTML = "";
                 return;
            }
            
            // Note: In real app, efficient search requires backend indexing. 
            // Here we just fetch username ref.
            get(child(ref(db), `usernames/${query}`)).then((snapshot) => {
                const resDiv = document.getElementById('search-results');
                resDiv.innerHTML = "";
                
                if (snapshot.exists()) {
                    const uid = snapshot.val();
                    if (uid === currentUser.uid) return; // Don't show self
                    
                    get(child(ref(db), `users/${uid}`)).then((userSnap) => {
                        const user = userSnap.val();
                        resDiv.innerHTML = `
                            <div class="user-list-item" onclick="openChat('${uid}')">
                                <div class="avatar">${user.emoji}</div>
                                <div class="user-info">
                                    <div class="user-name">${user.name}</div>
                                    <div class="user-meta">@${user.username}</div>
                                </div>
                                <button class="btn-primary" style="width:auto; padding:5px 15px; font-size:0.8rem;">Chat</button>
                            </div>
                        `;
                    });
                } else {
                    resDiv.innerHTML = "<p style='color:grey; text-align:center; margin-top:10px'>User not found</p>";
                }
            });
        };

        // --- CHAT LOGIC ---
        window.openChat = async (targetUid) => {
            // Get user details
            const snap = await get(child(ref(db), `users/${targetUid}`));
            const targetUser = snap.val();
            currentChatUser = { ...targetUser, uid: targetUid };

            // Determine Chat ID (alphabetical)
            currentChatId = currentUser.uid < targetUid ? `${currentUser.uid}_${targetUid}` : `${targetUid}_${currentUser.uid}`;
            
            // UI Setup
            document.getElementById('chat-header-name').innerText = targetUser.name;
            document.getElementById('chat-header-emoji').innerText = targetUser.emoji;
            document.getElementById('messages-list').innerHTML = ""; // Clear prev
            
            showScreen('chat-room');
            
            // Check Block Status
            checkBlockStatus(targetUid);
            
            // Load Messages
            const messagesRef = ref(db, `chats/${currentChatId}/messages`);
            onValue(messagesRef, (snapshot) => {
                const list = document.getElementById('messages-list');
                list.innerHTML = "";
                if (snapshot.exists()) {
                    snapshot.forEach((childSnapshot) => {
                        const msg = childSnapshot.val();
                        renderMessage(msg, childSnapshot.key);
                    });
                    list.scrollTop = list.scrollHeight;
                }
            });
        };

        function checkBlockStatus(otherUid) {
            // Check if I blocked them
            get(child(ref(db), `blocked/${currentUser.uid}/${otherUid}`)).then(s => {
                if(s.exists()) {
                    // I blocked them
                }
            });

            // Check if they blocked me (Using strict rules usually prevents read, but here we assume we can read for UI logic)
            // Or simpler: check if I can write.
            // For UI simplicity:
            get(child(ref(db), `blocked/${otherUid}/${currentUser.uid}`)).then(s => {
                const inputArea = document.getElementById('chat-input-area');
                const bar = document.getElementById('blocked-msg-bar');
                if (s.exists()) {
                    inputArea.style.display = 'none';
                    bar.style.display = 'block';
                } else {
                    inputArea.style.display = 'flex';
                    bar.style.display = 'none';
                }
            });
        }

        function renderMessage(msg, msgKey) {
            const isMe = msg.sender === currentUser.uid;
            const div = document.createElement('div');
            div.className = `message ${isMe ? 'msg-sent' : 'msg-received'}`;
            
            let content = '';
            if (msg.type === 'text') content = msg.content;
            else if (msg.type === 'image') content = `<div class="msg-media"><img src="${msg.content}"></div>`;
            else if (msg.type === 'video') content = `<div class="msg-media"><video controls src="${msg.content}"></video></div>`;
            else if (msg.type === 'audio') content = `<audio controls src="${msg.content}"></audio>`;

            div.innerHTML = `
                ${content}
                <span class="msg-time">${new Date(msg.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>
                <div class="msg-delete" onclick="deleteMessage('${msgKey}')"><i class="fas fa-trash"></i></div>
            `;
            document.getElementById('messages-list').appendChild(div);
        }

        window.sendTextMessage = () => {
            const input = document.getElementById('message-input');
            const text = input.value.trim();
            if(!text) return;
            pushMessage('text', text);
            input.value = "";
        };

        function pushMessage(type, content) {
            // Check block again before sending
            get(child(ref(db), `blocked/${currentChatUser.uid}/${currentUser.uid}`)).then(s => {
                if(s.exists()) {
                    showToast("You are blocked by this user.");
                    return;
                }
                
                const msgData = {
                    sender: currentUser.uid,
                    type: type,
                    content: content,
                    timestamp: Date.now()
                };
                
                push(ref(db, `chats/${currentChatId}/messages`), msgData);
                
                // Update UserChat Lists for list view
                const meta = {
                    lastMessage: type === 'text' ? content : 'Sent a file',
                    timestamp: Date.now(),
                    with: currentChatUser.uid
                };
                
                update(ref(db, `userChats/${currentUser.uid}/${currentChatId}`), meta);
                update(ref(db, `userChats/${currentChatUser.uid}/${currentChatId}`), {
                    ...meta, with: currentUser.uid
                });
            });
        }

        window.deleteMessage = (msgKey) => {
            confirmAction("Delete Message", "Delete this message?", () => {
                remove(ref(db, `chats/${currentChatId}/messages/${msgKey}`));
            });
        };

        window.closeChat = () => {
            currentChatId = null;
            currentChatUser = null;
            showScreen('main-app-screen');
            loadChats(); // Refresh list
        };

        window.toggleChatMenu = () => document.getElementById('chat-menu').classList.toggle('show');

        // --- MEDIA & VOICE ---
        window.handleFileSelect = (input) => {
            const file = input.files[0];
            if (!file) return;
            
            const type = file.type.startsWith('image') ? 'image' : 'video';
            const storageRef = sRef(storage, `chat_media/${Date.now()}_${file.name}`);
            
            showToast("Uploading...");
            uploadBytes(storageRef, file).then((snapshot) => {
                getDownloadURL(snapshot.ref).then((url) => {
                    pushMessage(type, url);
                    showToast("Done");
                });
            }).catch(err => showToast("Upload Failed: Check Storage Config"));
        };

        window.startRecording = () => {
             navigator.mediaDevices.getUserMedia({ audio: true })
            .then(stream => {
                mediaRecorder = new MediaRecorder(stream);
                mediaRecorder.start();
                audioChunks = [];
                showToast("Recording...");
                
                mediaRecorder.addEventListener("dataavailable", event => {
                    audioChunks.push(event.data);
                });

                mediaRecorder.addEventListener("stop", () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/mp3' });
                    const storageRef = sRef(storage, `voice_notes/${Date.now()}.mp3`);
                    uploadBytes(storageRef, audioBlob).then((snapshot) => {
                        getDownloadURL(snapshot.ref).then((url) => {
                            pushMessage('audio', url);
                        });
                    });
                });
            });
        };

        window.stopRecording = () => {
            if(mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                showToast("Sending Audio...");
            }
        };

        // --- CHAT LIST ---
        function loadChats() {
            const listDiv = document.getElementById('chat-list-container');
            listDiv.innerHTML = '<p style="text-align:center; padding:20px; color:grey;">Loading...</p>';
            
            const chatsRef = ref(db, `userChats/${currentUser.uid}`);
            onValue(chatsRef, (snapshot) => {
                listDiv.innerHTML = "";
                if (!snapshot.exists()) {
                    listDiv.innerHTML = '<p style="text-align:center; padding:20px; color:grey;">No chats yet. Search for users!</p>';
                    return;
                }
                
                snapshot.forEach((childSnap) => {
                    const chatMeta = childSnap.val();
                    const otherUid = chatMeta.with;
                    
                    // Fetch other user profile
                    get(child(ref(db), `users/${otherUid}`)).then((uSnap) => {
                        const otherUser = uSnap.val();
                        if(!otherUser) return;
                        
                        const div = document.createElement('div');
                        div.className = 'user-list-item';
                        div.innerHTML = `
                            <div class="avatar">${otherUser.emoji}</div>
                            <div class="user-info">
                                <div class="user-name">${otherUser.name}</div>
                                <div class="user-meta">
                                    <span>${chatMeta.lastMessage}</span>
                                    <span>${new Date(chatMeta.timestamp).toLocaleTimeString([],{hour:'2-digit', minute:'2-digit'})}</span>
                                </div>
                            </div>
                            <button class="delete-chat-btn" onclick="deleteEntireChat('${childSnap.key}', event)"><i class="fas fa-trash"></i></button>
                        `;
                        div.onclick = (e) => {
                            if(!e.target.closest('.delete-chat-btn')) openChat(otherUid);
                        };
                        listDiv.appendChild(div);
                    });
                });
            });
        }

        window.deleteEntireChat = (chatId, e) => {
            if(e) e.stopPropagation();
            confirmAction("Delete Chat", "This will remove chat from your list.", () => {
                remove(ref(db, `userChats/${currentUser.uid}/${chatId}`)).then(() => {
                    // Optional: remove actual messages if both delete? Usually just hide from user
                    showToast("Chat deleted done");
                });
            });
        }
        
        window.deleteCurrentChat = () => {
            if(!currentChatId) return;
            confirmAction("Delete Chat", "Clear this conversation?", () => {
                remove(ref(db, `userChats/${currentUser.uid}/${currentChatId}`));
                closeChat();
                showToast("Chat deleted done");
            });
        }

        // --- BLOCKING ---
        window.blockCurrentUser = () => {
             confirmAction("Block User", `Block ${currentChatUser.name}?`, () => {
                 set(ref(db, `blocked/${currentUser.uid}/${currentChatUser.uid}`), true).then(() => {
                     showToast("Blocked User Done");
                     closeChat();
                 });
             });
        };

        window.showBlockedList = () => {
            switchTab('blocked');
            document.getElementById('main-menu').classList.remove('show');
            const cont = document.getElementById('blocked-list-container');
            cont.innerHTML = "Loading...";
            
            get(child(ref(db), `blocked/${currentUser.uid}`)).then(snap => {
                cont.innerHTML = "";
                if(!snap.exists()) {
                    cont.innerHTML = "<p style='color:grey'>No blocked users.</p>";
                    return;
                }
                snap.forEach(b => {
                    const blockedUid = b.key;
                    get(child(ref(db), `users/${blockedUid}`)).then(uSnap => {
                        const u = uSnap.val();
                        const div = document.createElement('div');
                        div.className = 'user-list-item';
                        div.innerHTML = `
                             <div class="avatar">${u.emoji}</div>
                             <div class="user-info"><div class="user-name">${u.name}</div></div>
                             <button class="btn-outline" style="width:auto; margin:0;" onclick="unblockUser('${blockedUid}')">Unblock</button>
                        `;
                        cont.appendChild(div);
                    });
                });
            });
        };

        window.unblockUser = (uid) => {
            remove(ref(db, `blocked/${currentUser.uid}/${uid}`)).then(() => {
                showToast("Unblocked");
                showBlockedList(); // Refresh
            });
        };

        window.viewChatProfile = () => {
            document.getElementById('profile-preview').style.display = 'flex';
            document.getElementById('preview-emoji').innerText = currentChatUser.emoji;
            document.getElementById('preview-name').innerText = currentChatUser.name;
            document.getElementById('preview-username').innerText = "@" + currentChatUser.username;
        };

        // --- UTILS ---
        window.showToast = (msg) => {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        };

        let confirmCallback = null;
        window.confirmAction = (title, msg, callback) => {
            document.getElementById('confirm-title').innerText = title;
            document.getElementById('confirm-msg').innerText = msg;
            document.getElementById('confirm-modal').style.display = 'flex';
            confirmCallback = callback;
        };

        document.getElementById('confirm-yes-btn').onclick = () => {
            if (confirmCallback) confirmCallback();
            closeConfirm();
        };

        window.closeConfirm = () => {
            document.getElementById('confirm-modal').style.display = 'none';
            confirmCallback = null;
        };

    </script>
</body>
</html>
